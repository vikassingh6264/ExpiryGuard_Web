# GitLab CI/CD configuration for deploying Vite React app to GitLab Pages

image: node:18

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/

# Define stages
stages:
  - build
  - deploy

# Build stage - compile the React app
build:
  stage: build
  script:
    - echo "Installing dependencies..."
    - npm ci
    - echo "Building the application..."
    - npm run build
    - echo "Build completed successfully!"
    - echo "Checking dist folder contents:"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main

# Deploy stage - deploy to GitLab Pages
pages:
  stage: deploy
  script:
    - echo "Preparing deployment to GitLab Pages..."
    - rm -rf public
    - mv dist public
    - cp public/index.html public/404.html
    - touch public/.nojekyll
    - echo "Deployment prepared!"
    - echo "Public folder contents:"
    - ls -la public/
    - echo "Checking if index.html exists:"
    - test -f public/index.html && echo "✓ index.html found" || echo "✗ index.html NOT found"
    - echo "Total files in public:"
    - find public -type f | wc -l
  artifacts:
    paths:
      - public
  only:
    - main
  dependencies:
    - build
